#include "dco.h"
#include "midi.h"


unsigned int midiNote[]= { 1685510,
                            1785736,
                            1891921,
                            2004420,
                            2123609,
                            2249886,
                            2383671,
                            2525411,
                            2675580,
                            2834678,
                            3003237,
                            3181819,
                            3371020,
                            3571471,
                            3783842,
                            4008841,
                            4247219,
                            4499771,
                            4767342,
                            5050823,
                            5351160,
                            5669357,
                            6006474,
                            6363638,
                            6742039,
                            7142942,
                            7567683,
                            8017681,
                            8494437,
                            8999543,
                            9534684,
                            10101645,
                            10702321,
                            11338714,
                            12012949,
                            12727276,
                            13484079,
                            14285884,
                            15135367,
                            16035363,
                            16988875,
                            17999086,
                            19069367,
                            20203291,
                            21404641,
                            22677427,
                            24025897,
                            25454552,
                            26968158,
                            28571768,
                            30270734,
                            32070725,
                            33977750,
                            35998172,
                            38138735,
                            40406582,
                            42809282,
                            45354855,
                            48051795,
                            50909103,
                            53936316,
                            57143536,
                            60541468,
                            64141451,
                            67955500,
                            71996344,
                            76277469,
                            80813164,
                            85618565,
                            90709709,
                            96103589,
                            101818206,
                            107872632,
                            114287072,
                            121082935,
                            128282901,
                            135910999,
                            143992688,
                            152554939,
                            161626327,
                            171237129,
                            181419419,
                            192207179,
                            203636412,
                            215745263,
                            228574144,
                            242165870,
                            256565802,
                            271821999,
                            287985376,
                            305109877,
                            323252655,
                            342474258,
                            362838837,
                            384414357,
                            407272824,
                            431490527,
                            457148289,
                            484331740,
                            513131604,
                            543643997,
                            575970752,
                            610219755,
                            646505310,
                            684948516,
                            725677674,
                            768828714,
                            814545649,
                            862981053,
                            914296577,
                            968663481,
                            1026263209,
                            1087287995,
                            1151941503,
                            1220439510,
                            1293010620,
                            1369897032,
                            1451355349,
                            1537657429,
                            1629091297,
                            1725962107,
                            1828593154,
                            1937326962,
                            2052526418,
                            2174575990,
                            2303883007,
                            2440879020,
                            2586021239    };


unsigned int detunes[] = { 6264,
                            6637,
                            7031,
                            7449,
                            7892,
                            8362,
                            8859,
                            9386,
                            9944,
                            10535,
                            11161,
                            11825,
                            12528,
                            13273,
                            14062,
                            14899,
                            15785,
                            16723,
                            17718,
                            18771,
                            19887,
                            21070,
                            22323,
                            23650,
                            25056,
                            26546,
                            28125,
                            29797,
                            31569,
                            33446,
                            35435,
                            37542,
                            39775,
                            42140,
                            44645,
                            47300,
                            50113,
                            53093,
                            56250,
                            59595,
                            63138,
                            66893,
                            70870,
                            75084,
                            79549,
                            84279,
                            89291,
                            94600,
                            100226,
                            106185,
                            112499,
                            119189,
                            126276,
                            133785,
                            141740,
                            150169,
                            159098,
                            168559,
                            178582,
                            189201,
                            200451,
                            212371,
                            224999,
                            238378,
                            252553,
                            267570,
                            283481,
                            300338,
                            318197,
                            337118,
                            357164,
                            378402,
                            400903,
                            424741,
                            449998,
                            476756,
                            505106,
                            535141,
                            566962,
                            600675,
                            636393,
                            674235,
                            714327,
                            756803,
                            801805,
                            849483,
                            899996,
                            953512,
                            1010211,
                            1070281,
                            1133924,
                            1201350,
                            1272786,
                            1348470,
                            1428654,
                            1513606,
                            1603610,
                            1698966,
                            1799991,
                            1907025,
                            2020422,
                            2140563,
                            2267847,
                            2402700,
                            2545572,
                            2696940,
                            2857308,
                            3027213,
                            3207220,
                            3397931,
                            3599983,
                            3814049,
                            4040844,
                            4281125,
                            4535694,
                            4805401,
                            5091145,
                            5393880,
                            5714617,
                            6054426,
                            6414440,
                            6795863,
                            7199966,
                            7628098,
                            8081689,
                            8562251,
                            9071389,
                            9610802    };



char DCO_calculate(char voice) {
    char detune = pitch_bend>>7;
    char note = voices[voice].note + (detune>>4);
    static int dco_value[VOICES] = {0};

    if(note < 0) {
        note = 0;
    }
    else {
        if(note > 127) {
            note = 127;
        }
    }
    dco_value[note] += midiNote[note]+detunes[note]*((detune)&0x0f);

    return (dco_value[note] > 0);
}
